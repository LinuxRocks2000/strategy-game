<!--
    By Tyler Clarke
    UI for MMOSG, a multiplayer strategy game (basically Rampart + Galaga)
-->
<!-- Oh, how I hate single file websites... Eh. This is the easiest way to handle the site. -->

<!DOCTYPE html>


<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Strategy MMO</title>
        <style>
            body{
                margin: 0px;
                padding: 0px;
                overflow: hidden;
            }
            #mainscreen {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
            }
            #start {
                border: none;
                padding: 20px;
            }
            #game{
                width: 100vw;
                height: 100vh;
                position: absolute;
                top: 0px;
                left: 0px;
            }
        </style>
    </head>
    <body>
        <div id="mainscreen">
            Banner (one word only - anything after a space will be ignored; this helps other players identify who's shooting at them and who won): <input type="text" id="banner" /><br />
            Entry code (leave blank for spectator mode): <input type="text" id="code" /><br/>
            <button id="start" onclick="start();">Start</button>
        </div>
        <canvas id="game" style="display: none;">

        </canvas>
        <script>
            var canvas = document.getElementById("game");
            var ctx = canvas.getContext("2d");
            var connection = new WebSocket("ws" + (window.location.protocol == "https:" ? "s" : "") + "://" + location.host + location.pathname + (location.pathname.endsWith("/") ? "" : "/") + "game"); // Make it adaptive, so it fits in my reverse proxy
            connection.onopen = () => {
                setInterval(() => {
                    connection.send("_");
                }, 100);
            };
            var playing = false;
            var cX = 0;
            var cY = 0;
            var xv = 0;
            var yv = 0;
            var gameSize = 0;
            var keysDown = {};
            var didSelectHome = false;
            var isStratChange = false;
            var counter = 0;
            var hovered = undefined;
            var selected = undefined;
            var angleAdjustMode = false;
            var score = 0;
            var wallsRemaining = 4;
            var wasPlayMode = false;
            var myCastle = undefined;
            var canPlaceWall = false;
            var inventoryMode = false;
            var inventoryHovered = -1;
            var wallsTurn = 2;
            var banners = [];

            var inventoryStuff = [
                {
                    name: "Basic Fighter",
                    word: "f",
                    cost: 10
                },
                {
                    name: "Tie Fighter",
                    word: "t",
                    cost: 20
                },
                {
                    name: "Sniper",
                    word: "s",
                    cost: 30
                },
                {
                    name: "Extra Walls",
                    cbk: () => {
                        wallsTurn += 2;
                    },
                    cost: 30
                }
            ];

            var objects = {

            };

            var mine = [];

            window.onkeydown = (evt) => {
                keysDown[evt.key] = true;
            };

            window.onkeyup = (evt) => {
                keysDown[evt.key] = false;
                if (evt.key == "i") {
                    if (isStratChange && playing && didSelectHome){
                        if (inventoryMode){
                            inventoryMode = false;
                        }
                        else{
                            inventoryMode = true;
                        }
                    }
                    else{
                        inventoryMode = false;
                    }
                }
                else if (evt.key == "w"){
                    if (wallsRemaining > 0){
                        if (playing && isStratChange){
                            if (canPlaceWall){
                                wallsRemaining --;
                                connection.send("pw " + mousePos.gameX + " " + mousePos.gameY);
                            }
                        }
                    }
                }
            };

            function setName(name){
                document.title = name;
            }

            function splitString(string, delim = " "){
                var ret = [];
                var buf = "";
                var escape = false;
                for (var i = 0; i < string.length; i ++){
                    if (!escape){
                        if (string[i] == '\\'){
                            escape = true;
                            continue;
                        }
                        else if (string[i] == delim){
                            ret.push(buf);
                            buf = "";
                        }
                    }
                    buf += string[i];
                }
                if (buf.length > 0){
                    ret.push(buf);
                }
                return ret;
            }

            connection.onmessage = (message) => {
                var data = message.data;
                var command = data[0];
                var args = data.substring(1, data.length).split(" ");
                if (data[0] == "B"){
                    alert(data.substring(1, data.length));
                }
                else if (command == "s"){
                    console.log("an event was successful");
                    if (mode == 1){
                        playing = true;
                        play();
                    }
                }
                else if (command == "e"){
                    if (mode == 1 && args[0] == 0){
                        alert("Wrong code!");
                        window.location.reload();
                    }
                    else{
                        console.error("Got ERROR " + args[0]);
                    }
                }
                else if (command == "b"){
                    banners.push(args[0]);
                }
                else if (command == "T"){
                    alert("Game over! It was a tie - nobody was left alive at the end. Pretty L, in my opinion.");
                }
                else if (command == "W"){
                    alert("You won! Your final score: " + score);
                }
                else if (command == "E"){
                    alert("Game over! <" + banners[args[0]] + "> won.");
                }
                else if (command == "w"){
                    console.warn("Got warning " + args[0]);
                    if (mode == 1){
                        play();
                    }
                }
                else if (command == "m"){
                    gameSize = args[0] - 0;
                    setName(args[1]);
                }
                else if (command == "n"){
                    objects[args[1] - 0] = {
                        value: args[0],
                        id: args[1] - 0,
                        x: args[2] - 0,
                        y: args[3] - 0,
                        angle: args[4] - 0,
                        isEditable: args[5] == "1",
                        goalPos: {
                            x: args[2] - 0,
                            y: args[3] - 0,
                            angle: args[4] - 0
                        },
                        banner: args[6]
                    };
                }
                else if (command == "a"){
                    console.log(args);
                    if (objects[args[0] - 0].value == "c"){
                        myCastle = objects[args[0] - 0];
                    }
                    mine.push(args[0] - 0);
                }
                else if (command == "t"){
                    counter = args[0] - 0;
                    if (args[1] == "1"){
                        isStratChange = true;
                        if (wasPlayMode){
                            wallsRemaining = wallsTurn;
                        }
                        wasPlayMode = false;
                    }
                    else{
                        isStratChange = false;
                        wasPlayMode = true;
                    }
                }
                else if (command == "M"){
                    var obj = objects[args[0] - 0];
                    obj.x = args[1] - 0;
                    obj.y = args[2] - 0;
                    obj.angle = args[3] - 0;
                }
                else if (command == "d"){
                    delete objects[args[0] - 0];
                }
                else if (command == "S"){
                    score = args[0] - 0;
                }
                else if (command == "l"){
                    playing = false;
                    mine = [];
                    alert("You lose! You can close the tab now, or continue as a spectator. If it makes you feel any better, the person responsible for your loss got 50 points!");
                }
                else {
                    console.warn("Got unrecognizable data: " + message.data);
                }
            };
            var mode = 0;
            function start(){
                var banner = document.getElementById("banner").value.trim();
                var passcode = document.getElementById("code").value.trim();
                if (passcode.length == 0){
                    passcode = "_spectator";
                }
                if (banner.length == 0){
                    banner = "Player";
                }
                connection.send("c" + passcode + " " + banner);
                mode = 1; // waiting for a response
            }

            var mousePos = {
                gameX: 0,
                gameY: 0,
                realX: 0,
                realY: 0
            };

            window.addEventListener("mousemove", (evt) => {
                mousePos.realX = evt.clientX;
                mousePos.realY = evt.clientY;
            });

            function mainloop(){
                requestAnimationFrame(mainloop);
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
                inventoryHovered = -1;
                if (inventoryMode) {
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.font = "bold 40px monospace";
                    ctx.fillText("Inventory", window.innerWidth/2, 100);
                    var columnCount = Math.floor(window.innerWidth / 200);
                    for (var i = 0; i < inventoryStuff.length; i ++){
                        var x = i % columnCount;
                        var y = 2 + Math.floor(i / columnCount);
                        x *= 200;
                        y *= 100;
                        ctx.fillStyle = "black";
                        ctx.font = "12px monospace";
                        ctx.fillText(inventoryStuff[i].name, x + 100, y + 20);
                        ctx.fillText(inventoryStuff[i].cost, x + 100, y + 80);
                        if (score >= inventoryStuff[i].cost){
                            ctx.fillStyle = "green";
                            ctx.font = "bold 12px sans-serif";
                            ctx.fillText("[ CLICK TO BUY ]", x + 100, y + 50);
                        }
                        else {
                            ctx.fillStyle = "red";
                            ctx.font = "bold 12px sans-serif";
                            ctx.fillText("[ INSUFFICIENT SCORE ]", x + 100, y + 50);
                        }
                        if ((mousePos.realX > x) && (mousePos.realX < x + 200) && (mousePos.realY > y) && (mousePos.realY < y + 100)) {
                            inventoryHovered = i;
                            ctx.strokeStyle = "yellow";
                            ctx.lineWidth = 5;
                            ctx.strokeRect(x, y, 200, 100);
                        }
                    }
                    return;
                }
                if (myCastle) {
                    canPlaceWall = (Math.abs(mousePos.gameX - myCastle.x) < 400) && (Math.abs(mousePos.gameY - myCastle.y) < 400);
                }
                else {
                    canPlaceWall = false;
                }
                mousePos.gameX = mousePos.realX + cX;
                mousePos.gameY = mousePos.realY + cY;
                if (mousePos.gameX > gameSize) {
                    mousePos.gameX = gameSize;
                }
                else if (mousePos.gameX < 0) {
                    mousePos.gameX = 0;
                }

                if (mousePos.gameY > gameSize) {
                    mousePos.gameY = gameSize;
                }
                else if (mousePos.gameY < 0) {
                    mousePos.gameY = 0;
                }
                ctx.translate(-cX, -cY);

                ctx.strokeStyle = "black";
                ctx.fillStyle = "lightblue";
                ctx.lineWidth = 10;
                ctx.strokeRect(0, 0, gameSize, gameSize);
                ctx.fillRect(0, 0, gameSize, gameSize);
                ctx.fillStyle = "black";
                ctx.fillRect(mousePos.gameX - 5, mousePos.gameY - 5, 10, 10);

                hovered = undefined;
                Object.keys(objects).forEach(id => {
                    var object = objects[id];
                    if (object.value == "c"){
                        if (mine.indexOf(object.id) == -1){
                            ctx.fillStyle = "green";
                        }
                        else{
                            ctx.fillStyle = "lightgreen";
                        }
                        ctx.fillRect(object.x - 25, object.y - 25, 50, 50);
                    }
                    else if (object.value == "f"){
                        if (mine.indexOf(object.id) == -1){
                            ctx.fillStyle = "purple";
                        }
                        else {
                            ctx.fillStyle = "#FFAAFF";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -3, 70, 6);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(10, 0);
                        ctx.lineTo(0, -10);
                        ctx.lineTo(0, 10);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.restore();
                    }
                    else if (object.value == "t") {
                        if (mine.indexOf(object.id) == -1) {
                            ctx.fillStyle = "blue";
                        }
                        else {
                            ctx.fillStyle = "#00AAFF";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -3, 70, 6);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(10, 0);
                        ctx.lineTo(0, -10);
                        ctx.lineTo(0, 10);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.fillStyle = "black";
                        ctx.fillRect(-40, -10, 30, 2);
                        ctx.fillRect(-40, 10, 30, 2);
                        ctx.restore();
                    }
                    else if (object.value == "s") {
                        if (mine.indexOf(object.id) == -1) {
                            ctx.fillStyle = "black";
                        }
                        else {
                            ctx.fillStyle = "#555555";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -1, 70, 2);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(0, -10);
                        ctx.lineTo(10, 0);
                        ctx.lineTo(0, 10);
                        ctx.stroke();
                        ctx.restore();
                    }
                    else if (object.value == "b"){
                        ctx.fillStyle = "green";
                        ctx.beginPath();
                        ctx.arc(object.x, object.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    else if (object.value == "w"){
                        ctx.fillStyle = "grey";
                        ctx.fillRect(object.x - 15, object.y - 15, 30, 30);
                    }
                    else if (object.value == "C"){
                        ctx.fillStyle = "pink";
                        ctx.fillRect(object.x - 15, object.y - 15, 30, 10);
                        ctx.fillStyle = "gold";
                        ctx.fillRect(object.x - 15, object.y - 5, 30, 20);
                    }
                    if (mousePos.gameX > object.x - 10 && mousePos.gameX < object.x + 10 && mousePos.gameY > object.y - 10 && mousePos.gameY < object.y + 10) {
                        if (mine.indexOf(object.id) != -1) {
                            if (object.isEditable){
                                object.hovered = true;
                                ctx.strokeStyle = "yellow";
                                ctx.lineWidth = 3;
                                ctx.strokeRect(object.x - 10, object.y - 10, 20, 20);
                                hovered = object;
                            }
                        }
                        else {
                            ctx.fillStyle = "red";
                            ctx.font = "10px sans-serif";
                            var size = ctx.measureText(banners[object.banner]);
                            ctx.fillRect(mousePos.gameX - size.width - 5, mousePos.gameY - 15, size.width + 10, 20);
                            ctx.textAlign = "left";
                            ctx.fillStyle = "black";
                            ctx.fillText(banners[object.banner], mousePos.gameX - size.width, mousePos.gameY);
                        }
                    }
                    if (object.isEditable && mine.indexOf(object.id) != -1){
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = "black";
                        ctx.beginPath();
                        ctx.moveTo(object.x, object.y);
                        ctx.lineTo(object.goalPos.x, object.goalPos.y);
                        ctx.stroke();
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(object.goalPos.x, object.goalPos.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "blue";
                        ctx.beginPath();
                        ctx.moveTo(object.goalPos.x, object.goalPos.y);
                        ctx.lineTo(object.goalPos.x + Math.cos(object.goalPos.angle) * 20, object.goalPos.y + Math.sin(object.goalPos.angle) * 20);
                        ctx.stroke();
                    }
                });
                if (isStratChange){
                    if (selected) {
                        if (angleAdjustMode) {
                            selected.goalPos.angle = Math.atan2(mousePos.gameY - selected.goalPos.y, mousePos.gameX - selected.goalPos.x);
                        }
                        else {
                            selected.goalPos.x = mousePos.gameX;
                            selected.goalPos.y = mousePos.gameY;
                        }
                        connection.send("m" + selected.id + " " + selected.goalPos.x + " " + selected.goalPos.y + " " + selected.goalPos.angle);
                    }
                }
                else{
                    selected = undefined;
                    angleAdjustMode = false;
                    hovered = undefined;
                }
                if (keysDown["c"] && myCastle) {
                    ctx.fillStyle = "white";
                    ctx.strokeStyle = "blue";
                    ctx.lineWidth = 10;
                    ctx.beginPath();
                    ctx.arc(mousePos.gameX, mousePos.gameY, 100, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(mousePos.gameX, mousePos.gameY);
                    var dX = mousePos.gameX - myCastle.x;
                    var dY = mousePos.gameY - myCastle.y;
                    var distance = Math.sqrt(dX * dX + dY * dY);
                    dX /= distance;
                    dY /= distance;
                    ctx.strokeStyle = "red";
                    ctx.lineTo(mousePos.gameX + -dX * 150, mousePos.gameY + -dY * 150);
                    ctx.stroke();
                    /*objects.forEach(obj => {
                        if (obj.value == "c"){
                            
                        }
                    });*/
                }
                ctx.translate(cX, cY);
                if (keysDown["ArrowUp"]){
                    yv -= 5;
                }
                if (keysDown["ArrowDown"]){
                    yv += 5;
                }
                if (keysDown["ArrowLeft"]){
                    xv -= 5;
                }
                if (keysDown["ArrowRight"]){
                    xv += 5;
                }
                yv *= 0.8;
                xv *= 0.8;
                cY += yv;
                cX += xv;
                if (cX < -window.innerWidth/2){
                    cX = -window.innerWidth/2;
                }
                if (cX > gameSize - window.innerWidth/2){
                    cX = gameSize - window.innerWidth/2;
                }
                if (cY < -window.innerHeight/2){
                    cY = -window.innerHeight/2;
                }
                if (cY > gameSize - window.innerHeight/2){
                    cY = gameSize - window.innerHeight/2;
                }
                if (playing){
                    ctx.fillStyle = "red";
                    ctx.textAlign = "center";
                    ctx.font = "bold 40px monospace";
                    if (didSelectHome){
                        if (counter == 0){
                            ctx.fillText("Waiting for game start...", window.innerWidth/2, 100);
                        }
                        else if (isStratChange){
                            ctx.fillText("Move your ships!", window.innerWidth/2, 100);
                            // Ship movement goes here.
                        }
                    }
                    else{
                        ctx.fillText("Select Your Home Castle", window.innerWidth/2, 100);
                    }
                }
                ctx.font = "16px sans-serif";
                ctx.fillStyle = "black";
                ctx.textAlign = "left";
                ctx.fillText(score, 50, 50);
                ctx.fillStyle = "purple";
                ctx.fillText("Time Left in " + (isStratChange ? "strategy mode" : "play mode") + ": " + counter, 50, 100);
                if (wallsRemaining > 0){
                    ctx.textAlign = "right";
                    if (!canPlaceWall){
                        ctx.fillStyle = "red";
                    }
                    ctx.fillText("Remaining walls (" + (canPlaceWall ? "press W to place one!" : "can't place here!") + "): " + wallsRemaining, window.innerWidth - 50, 50);
                }
            }

            function play() {
                document.getElementById("mainscreen").style.display = "none";
                document.getElementById("game").style.display = "";

                window.addEventListener("mouseup", (evt) => {
                    if (didSelectHome){
                        if (inventoryHovered != -1) {
                            if (inventoryStuff[inventoryHovered].word){
                                connection.send("p" + inventoryStuff[inventoryHovered].word + " " + (myCastle.x + (Math.random() * 300 - 150)) + " " + (myCastle.y + (Math.random() * 300 - 150)));
                            }
                            else {
                                inventoryStuff[inventoryHovered].cbk();
                            }
                            inventoryMode = false;
                        }
                        else if (isStratChange){
                            if (angleAdjustMode) {
                                angleAdjustMode = false;
                                selected = undefined;
                                hovered = undefined;
                            }
                            else {
                                if (selected){
                                    angleAdjustMode = true;
                                }
                                if (hovered) {
                                    hovered.selected = true;
                                    selected = hovered;
                                }
                            }
                        }
                    }
                    else {
                        connection.send("pc " + mousePos.gameX + " " + mousePos.gameY); // place castle at position
                        didSelectHome = true;
                    }
                });
                
                mainloop();
            }

            window.onresize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            
            window.onresize();
        </script>
    </body>
</html>