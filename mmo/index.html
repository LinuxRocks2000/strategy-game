<!--
    By Tyler Clarke
    UI for MMOSG, a multiplayer strategy game (basically Rampart + Galaga)
-->
<!-- Oh, how I hate single file websites... Eh. This is the easiest way to handle the site. -->

<!DOCTYPE html>


<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Strategy MMO</title>
        <style>
            body{
                margin: 0px;
                padding: 0px;
                overflow: hidden;
                max-height: 100vh;
            }
            #mainscreen {
                /*position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);*/
                text-align: center;
                padding: 20vh;
                overflow-y: scroll;
                display: inline-block;
                max-height: 60vh;
            }
            #start {
                border: none;
                padding: 20px;
            }
            #game{
                width: 100vw;
                height: 100vh;
                position: absolute;
                top: 0px;
                left: 0px;
                /*filter: blur(1px) brightness(75%);*/
            }
            ul {
                text-align: left;
            }
            #menu {
                padding: 50px;
                margin: 50px;
                background-color: lightgrey;
            }
            #notConnected {
                position: absolute;
                top: 0px;
                left: 0px;
                padding: 50px;
                background-color: #111111;
                color: red;
                text-align: center;
            }
            #enableNotifs{
                font-size: 3em;
                position: absolute;
                bottom: 0px;
                right: 0px;
            }
        </style>
    </head>
    <body>
        <button id="enableNotifs" style="display: none;">Click To Enable Notifications</button>
        <div id="mainscreen">
            <div id="menu">
                Banner (one word only - anything after a space will be ignored; this helps other players identify who's shooting at them and who won):<input type="text" id="banner" /><br />
                Entry code (leave blank for spectator mode): <input type="text" id="code" /><br/>
                <button id="start" onclick="start();">Start</button><br><br>
            </div>
            MMOSG (Massively Multiplayer Online Strategy Game) is a video game developed by Tyler Clarke. It is the sequel to Strategy Game and is meant to host as many players as wish to join each other in friendly combat.
            It is played on a large board (usually 5000x5000 pixels, although it can be any size). When you enter the game, you may place a castle, and then you wait until the DM (the person controlling the server) begins the game.
            <h2>Basic Controls and Gameplay</h2>
            The arrow keys move you across the board. It's fairly easy to figure out - just press a few buttons, and you'll learn quickly (note: if at any time you start moving up, down, left, or right uncontrollably, press every arrow key and it should go back to normal. It's a browser problem).
            Mouse is how you do most of the actions. Click on the head of a ship you own, and the goal pos controller will stick to your mouse - click again to drop it at a position, and a third time to control the angle.
            You can move the canvas while moving pieces - this is how you move long distances efficiently.<br>
            There are two modes of play - "Move Ships" mode and "Watch" mode, usually known as "strat" and "play" mode. In strat mode, you move your ships and such, and if you haven't already used your entire wall allottment, you can press "w" to create a wall at your mouse position.
            In Watch mode, you can only hope you anticipated your enemy's motions well enough to defend against them, because you can't change your ship positioning. Strat mode lasts ~30 seconds and play mode ~20.<br>
            Most ships shoot bullets at regular intervals. These bullets (little green circles) hit things, destroying themselves and counting one hit towards the thing they hit; you can also hit things by running your ships into them, which will also count one hit. All flyers and bullets will be destroyed after one hit (bullets can hit bullets!), but walls and chests take two hits and castles take three.<br>
            Pressing "i" opens the inventory, in which you can buy things.<br>
            <b>Warning: Friendly fire is a thing! Your flyers can hit each other, your bullets can hit your flyers and your castle. All bullets and all flyers are approximately equal. I've seen people in a winning position lose because they forgot tie fighters shoot backwards!</b><br><br>
            Your goal is to destroy all enemy castles. This is a last-man-standing game!
            <h2>Types</h2>
            There are several types of objects in the game.
            <ul>
                <li>Castles: These are the large green squares. They're the most important piece, like the King in Chess; they withstand 3 hits.</li>
                <li>Walls: The little gray squares. Absorb two hits each. You can place a few every turn.</li>
                <li>Chests: Little pink-and-orange squares. They absorb two hits each as well, and have similar properties to a wall, except that whoever destroys them gets 50 points.</li>
                <li>Bullets: The tiny green circles. Destroy things. What else is there to say?</li>
                <li>Basic Fighters: Purple (pink, if they're on your side) fighters. Shoot single bullets out the front in whatever direction they're facing. You get a few at the start of the game. They're slow and don't have very good bullet range. Cost 10 points in the inventory.</li>
                <li>Tie Fighters: Basic Fighters, but blue and with small extensions. Shoot two bullets - one out the front, one out the back. Slightly faster than Basic Fighters. Hazardous. Cost 20 points in the inventory.</li>
                <li>Snipers: Skinny black fighters. Move very fast, are very controlled, and shoot much less often but have much higher range than the other fighters. Cost 30 points in the inventory.</li>
                <li>Hypersonic Missiles: Tiny ships with a similar design to enemies in the original Strategy Game: a small circle with a line extending well beyond it indicating direction. They don't shoot, but they move fast - good for dueling, because of how wide an area their swoops cover. Cost 5 points in the inventory (and they're barely worth it. Scutting little monsters.)</li>
            </ul>
        </div>
        <canvas id="game" style="display: none;">

        </canvas>
        <div id="notConnected">Not Connected!<br>Reload the page.</div>
        <script>
            var canvas = document.getElementById("game");
            var ctx = canvas.getContext("2d");
            var ping = false;
            var connected = true;
            var connection = connection = new WebSocket("ws" + (window.location.protocol == "https:" ? "s" : "") + "://" + location.host + location.pathname + (location.pathname.endsWith("/") ? "" : "/") + "game"); // Make it adaptive, so it fits in my reverse proxy;
            setInterval(() => {
                connected = !ping;
                connection.send("_");
                ping = true;
                var bannerNotConnected = document.getElementById("notConnected");
                if (!connected) {
                    bannerNotConnected.style.display = "";
                }
                else {
                    bannerNotConnected.style.display = "none";
                }
            }, 200);
            var playing = false;
            var cX = 0;
            var cY = 0;
            var xv = 0;
            var yv = 0;
            var gameSize = 0;
            var keysDown = {};
            var didSelectHome = false;
            var isStratChange = false;
            var counter = 0;
            var hovered = undefined;
            var selected = undefined;
            var angleAdjustMode = false;
            var score = 0;
            var wallsRemaining = 4;
            var wasPlayMode = false;
            var myCastle = undefined;
            var canPlaceWall = false;
            var inventoryMode = false;
            var inventoryHovered = -1;
            var wallsTurn = 2;
            var banners = {};
            var inventoryPlace = undefined;
            var timeToStart = -1;
            var canPlaceCastle = false;
            var sendNotifs = false;
            var isFirstTick = true;
            var effect = "none";
            var CRTEffectWipe = 0;
            document.getElementById("enableNotifs").onclick = () => {
                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        sendNotifs = true;
                    }
                });
                document.getElementById("enableNotifs").style.display = "none";
            };
            if (Notification.permission === "granted") {
                sendNotifs = true;
            }
            else {
                document.getElementById("enableNotifs").style.display = "";
            }

            function styleInfotextMajor(){
                ctx.fillStyle = "green";
                ctx.textAlign = "center";
                ctx.font = "bold 40px monospace";
            }

            var inventoryStuff = [
                {
                    name: "Basic Fighter",
                    word: "f",
                    cost: 10,
                    place: true
                },
                {
                    name: "Tie Fighter",
                    word: "t",
                    cost: 20,
                    place: true
                },
                {
                    name: "Sniper",
                    word: "s",
                    cost: 30,
                    place: true
                },
                {
                    name: "Hypersonic Missile",
                    word: "h",
                    cost: 5,
                    place: true
                },
                {
                    name: "Turret",
                    word: "T",
                    cost: 100,
                    place: true
                },
                {
                    name: "Fort",
                    word: "F",
                    cost: 120,
                    place: true
                },
                {
                    name: "Extra Walls",
                    cbk: () => {
                        wallsTurn += 2;
                        connection.send("C-30")
                    },
                    cost: 30
                }
            ];

            var objects = {

            };

            var mine = [];

            window.onkeydown = (evt) => {
                keysDown[evt.key] = true;
            };

            window.onkeyup = (evt) => {
                keysDown[evt.key] = false;
                if (evt.key == "i") {
                    if (isStratChange && playing && didSelectHome){
                        if (inventoryMode){
                            inventoryMode = false;
                        }
                        else{
                            inventoryMode = true;
                        }
                    }
                    else{
                        inventoryMode = false;
                    }
                }
                else if (evt.key == "w"){
                    if (wallsRemaining > 0){
                        if (playing && isStratChange){
                            if (canPlaceWall){
                                wallsRemaining --;
                                connection.send("pw " + mousePos.gameX + " " + mousePos.gameY);
                            }
                        }
                    }
                }
            };

            window.onwheel = (evt) => {
                xv += evt.deltaX;
                yv += evt.deltaY;
            };

            function setName(name){
                document.title = name;
            }

            function splitString(string, delim = " "){
                var ret = [];
                var buf = "";
                var escape = false;
                for (var i = 0; i < string.length; i ++){
                    if (!escape){
                        if (string[i] == '\\'){
                            escape = true;
                            continue;
                        }
                        else if (string[i] == delim){
                            ret.push(buf);
                            buf = "";
                        }
                    }
                    buf += string[i];
                }
                if (buf.length > 0){
                    ret.push(buf);
                }
                return ret;
            }

            connection.onmessage = (message) => {
                var data = message.data;
                var command = data[0];
                var args = data.substring(1, data.length).split(" ");
                if (data[0] == "B"){
                    alert(data.substring(1, data.length));
                }
                else if (command == "s"){
                    console.log("an event was successful");
                    if (mode == 1){
                        playing = true;
                        play();
                    }
                }
                else if (command == "!"){
                    if (timeToStart == -1) {
                        if (!document.hasFocus() && sendNotifs){
                            const notification = new Notification("Countdown started!");
                        }
                    }
                    timeToStart = args[0];
                }
                else if (command == "e"){
                    if (mode == 1 && args[0] == 0){
                        alert("Wrong code!");
                        window.location.reload();
                    }
                    else{
                        console.error("Got ERROR " + args[0]);
                    }
                }
                else if (command == "b"){
                    banners[args[0]] = args[1];
                }
                else if (command == "T"){
                    alert("Game over! It was a tie - nobody was left alive at the end. Pretty L, in my opinion.");
                }
                else if (command == "W"){
                    alert("You won! Your final score: " + score);
                }
                else if (command == "E"){
                    alert("Game over! <" + banners[args[0]] + "> won.");
                }
                else if (command == "w"){
                    console.warn("Got warning " + args[0]);
                    if (mode == 1){
                        play();
                    }
                }
                else if (command == "m"){
                    gameSize = args[0] - 0;
                    setName(args[1]);
                }
                else if (command == "n"){
                    objects[args[1] - 0] = {
                        value: args[0],
                        id: args[1] - 0,
                        x: args[2] - 0,
                        y: args[3] - 0,
                        angle: args[4] - 0,
                        isEditable: args[5] == "1",
                        goalPos: {
                            x: args[2] - 0,
                            y: args[3] - 0,
                            angle: args[4] - 0
                        },
                        banner: args[6]
                    };
                }
                else if (command == "a"){
                    console.log(args);
                    if (objects[args[0] - 0].value == "c"){
                        myCastle = objects[args[0] - 0];
                    }
                    mine.push(args[0] - 0);
                }
                else if (command == "t"){
                    counter = args[0] - 0;
                    if (isFirstTick){
                        if (!document.hasFocus() && sendNotifs) {
                            const notification = new Notification("Game started!");
                        }
                    }
                    isFirstTick = false;
                    if (args[1] == "1"){
                        isStratChange = true;
                        if (wasPlayMode){
                            wallsRemaining = wallsTurn;
                        }
                        wasPlayMode = false;
                    }
                    else{
                        isStratChange = false;
                        wasPlayMode = true;
                    }
                }
                else if (command == "M"){
                    var obj = objects[args[0] - 0];
                    obj.x = args[1] - 0;
                    obj.y = args[2] - 0;
                    obj.angle = args[3] - 0;
                }
                else if (command == "d"){
                    delete objects[args[0] - 0];
                }
                else if (command == "S"){
                    score = args[0] - 0;
                }
                else if (command == "l"){
                    playing = false;
                    mine = [];
                    alert("You lose! You can close the tab now, or continue as a spectator. If it makes you feel any better, the person responsible for your loss got 50 points!");
                }
                else if (command == "_"){
                    ping = false; // pong.
                }
                else {
                    console.warn("Got unrecognizable data: " + message.data);
                }
            };
            var mode = 0;
            function start(){
                var banner = document.getElementById("banner").value.trim();
                var passcode = document.getElementById("code").value.trim();
                if (passcode.length == 0){
                    passcode = "_spectator";
                }
                if (banner.length == 0){
                    banner = "Player";
                }
                connection.send("c" + passcode + " " + banner);
                mode = 1; // waiting for a response
            }

            var mousePos = {
                gameX: 0,
                gameY: 0,
                realX: 0,
                realY: 0
            };

            window.addEventListener("mousemove", (evt) => {
                mousePos.realX = evt.clientX;
                mousePos.realY = evt.clientY;
            });

            function mainloop(){
                requestAnimationFrame(mainloop);
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
                inventoryHovered = -1;
                if (inventoryMode) {
                    styleInfotextMajor();
                    ctx.fillText("Inventory", window.innerWidth / 2, 100);
                    var columnCount = Math.floor(window.innerWidth / 200);
                    for (var i = 0; i < inventoryStuff.length; i ++){
                        var x = i % columnCount;
                        var y = 2 + Math.floor(i / columnCount);
                        x *= 200;
                        y *= 100;
                        ctx.fillStyle = "white";
                        ctx.font = "12px monospace";
                        ctx.fillText(inventoryStuff[i].name, x + 100, y + 20);
                        ctx.fillText(inventoryStuff[i].cost, x + 100, y + 80);
                        styleInfotextMajor();
                        ctx.font = "12px monospace";
                        if (score >= inventoryStuff[i].cost){
                            ctx.fillText("[ CLICK TO BUY ]", x + 100, y + 50);
                        }
                        else {
                            ctx.fillText("[ INSUFFICIENT SCORE ]", x + 100, y + 50);
                        }
                        if ((mousePos.realX > x) && (mousePos.realX < x + 200) && (mousePos.realY > y) && (mousePos.realY < y + 100)) {
                            inventoryHovered = i;
                            ctx.strokeStyle = "yellow";
                            ctx.lineWidth = 5;
                            ctx.strokeRect(x, y, 200, 100);
                        }
                    }
                    return;
                }
                if (myCastle) {
                    canPlaceWall = (Math.abs(mousePos.gameX - myCastle.x) < 400) && (Math.abs(mousePos.gameY - myCastle.y) < 400) || inventoryPlace == "F";
                    mine.forEach(index => {
                        object = objects[index];
                        if (object && object.value == "F"){
                            canPlaceWall = canPlaceWall || (Math.abs(mousePos.gameX - object.x) < 400) && (Math.abs(mousePos.gameY - object.y) < 400);
                        }
                    });
                }
                else {
                    canPlaceWall = false;
                }
                canPlaceCastle = true;
                Object.values(objects).forEach(object => {
                    if (object){
                        if (mousePos.gameX > object.x - 600 &&
                            mousePos.gameX < object.x + 600 &&
                            mousePos.gameY > object.y - 600 &&
                            mousePos.gameY < object.y + 600) {
                            canPlaceCastle = false;
                        }
                    }
                });
                mousePos.gameX = mousePos.realX + cX;
                mousePos.gameY = mousePos.realY + cY;
                if (mousePos.gameX > gameSize) {
                    mousePos.gameX = gameSize;
                }
                else if (mousePos.gameX < 0) {
                    mousePos.gameX = 0;
                }

                if (mousePos.gameY > gameSize) {
                    mousePos.gameY = gameSize;
                }
                else if (mousePos.gameY < 0) {
                    mousePos.gameY = 0;
                }
                ctx.translate(-cX, -cY);

                ctx.strokeStyle = "black";
                ctx.fillStyle = "#555555";
                ctx.lineWidth = 10;
                ctx.strokeRect(0, 0, gameSize, gameSize);
                ctx.fillRect(0, 0, gameSize, gameSize);
                ctx.fillStyle = "black";
                ctx.fillRect(mousePos.gameX - 5, mousePos.gameY - 5, 10, 10);

                hovered = undefined;
                Object.keys(objects).forEach(id => {
                    var object = objects[id];
                    if (object.value == "c"){
                        if (mine.indexOf(object.id) == -1){
                            ctx.fillStyle = "green";
                        }
                        else{
                            ctx.fillStyle = "lightgreen";
                        }
                        ctx.fillRect(object.x - 25, object.y - 25, 50, 50);
                    }
                    else if (object.value == "F"){
                        ctx.fillStyle = "black";
                        ctx.fillRect(object.x - 10, object.y - 10, 20, 20);
                    }
                    else if (object.value == "f"){
                        if (mine.indexOf(object.id) == -1){
                            ctx.fillStyle = "purple";
                        }
                        else {
                            ctx.fillStyle = "#FFAAFF";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -3, 70, 6);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(10, 0);
                        ctx.lineTo(0, -10);
                        ctx.lineTo(0, 10);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.restore();
                    }
                    else if (object.value == "t") {
                        if (mine.indexOf(object.id) == -1) {
                            ctx.fillStyle = "blue";
                        }
                        else {
                            ctx.fillStyle = "#00AAFF";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -3, 70, 6);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(10, 0);
                        ctx.lineTo(0, -10);
                        ctx.lineTo(0, 10);
                        ctx.closePath();
                        ctx.stroke();
                        ctx.fillStyle = "black";
                        ctx.fillRect(-40, -10, 30, 2);
                        ctx.fillRect(-40, 10, 30, 2);
                        ctx.restore();
                    }
                    else if (object.value == "s") {
                        if (mine.indexOf(object.id) == -1) {
                            ctx.fillStyle = "black";
                        }
                        else {
                            ctx.fillStyle = "#555555";
                        }
                        ctx.save();
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillRect(-60, -1, 70, 2);
                        ctx.strokeStyle = ctx.fillStyle;
                        ctx.lineWidth = 4;
                        ctx.beginPath();
                        ctx.moveTo(0, -10);
                        ctx.lineTo(10, 0);
                        ctx.lineTo(0, 10);
                        ctx.stroke();
                        ctx.restore();
                    }
                    else if (object.value == "b"){
                        ctx.fillStyle = "green";
                        ctx.beginPath();
                        ctx.arc(object.x, object.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    else if (object.value == "h"){
                        if (mine.indexOf(object.id) == -1) {
                            ctx.strokeStyle = "#AA00AA";
                        }
                        else {
                            ctx.strokeStyle = "purple";
                        }
                        ctx.fillStyle = "brown";
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(object.x, object.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();
                        ctx.beginPath();
                        ctx.moveTo(object.x, object.y);
                        ctx.lineTo(object.x + Math.cos(object.angle) * 30, object.y + Math.sin(object.angle) * 30);
                        ctx.stroke();
                    }
                    else if (object.value == "w"){
                        ctx.fillStyle = "grey";
                        ctx.fillRect(object.x - 15, object.y - 15, 30, 30);
                    }
                    else if (object.value == "C"){
                        ctx.fillStyle = "pink";
                        ctx.fillRect(object.x - 15, object.y - 15, 30, 10);
                        ctx.fillStyle = "gold";
                        ctx.fillRect(object.x - 15, object.y - 5, 30, 20);
                    }
                    else if (object.value == "T"){
                        ctx.fillStyle = "black";
                        ctx.fillRect(object.x - 10, object.y - 10, 20, 20);
                        ctx.translate(object.x, object.y);
                        ctx.rotate(object.angle);
                        ctx.fillStyle = "yellow";
                        ctx.fillRect(-5, -2.5, 40, 5);
                        ctx.rotate(-object.angle);
                        ctx.translate(-object.x, -object.y);
                    }
                    else {
                        console.warn("Unkown object of type " + object.value);
                    }
                    if (mousePos.gameX > object.x - 10 && mousePos.gameX < object.x + 10 && mousePos.gameY > object.y - 10 && mousePos.gameY < object.y + 10) {
                        if (mine.indexOf(object.id) != -1) {
                            if (object.isEditable){
                                object.hovered = true;
                                ctx.strokeStyle = "yellow";
                                ctx.lineWidth = 3;
                                ctx.strokeRect(object.x - 10, object.y - 10, 20, 20);
                                hovered = object;
                            }
                        }
                        else {
                            ctx.fillStyle = "red";
                            ctx.font = "10px sans-serif";
                            var size = ctx.measureText(banners[object.banner]);
                            ctx.fillRect(mousePos.gameX - size.width - 5, mousePos.gameY - 15, size.width + 10, 20);
                            ctx.textAlign = "left";
                            ctx.fillStyle = "black";
                            ctx.fillText(banners[object.banner], mousePos.gameX - size.width, mousePos.gameY);
                        }
                    }
                    if (object.isEditable && mine.indexOf(object.id) != -1){
                        ctx.lineWidth = 1;
                        ctx.strokeStyle = "black";
                        ctx.beginPath();
                        ctx.moveTo(object.x, object.y);
                        ctx.lineTo(object.goalPos.x, object.goalPos.y);
                        ctx.stroke();
                        ctx.fillStyle = "red";
                        ctx.beginPath();
                        ctx.arc(object.goalPos.x, object.goalPos.y, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.lineWidth = 3;
                        ctx.strokeStyle = "blue";
                        ctx.beginPath();
                        ctx.moveTo(object.goalPos.x, object.goalPos.y);
                        ctx.lineTo(object.goalPos.x + Math.cos(object.goalPos.angle) * 20, object.goalPos.y + Math.sin(object.goalPos.angle) * 20);
                        ctx.stroke();
                    }
                });
                if (isStratChange){
                    if (selected) {
                        if (angleAdjustMode) {
                            selected.goalPos.angle = Math.atan2(mousePos.gameY - selected.goalPos.y, mousePos.gameX - selected.goalPos.x);
                        }
                        else {
                            selected.goalPos.x = mousePos.gameX;
                            selected.goalPos.y = mousePos.gameY;
                        }
                        connection.send("m" + selected.id + " " + selected.goalPos.x + " " + selected.goalPos.y + " " + selected.goalPos.angle);
                    }
                }
                else{
                    selected = undefined;
                    angleAdjustMode = false;
                    hovered = undefined;
                    inventoryPlace = undefined;
                }
                if (keysDown["c"] && myCastle) {
                    ctx.fillStyle = "white";
                    ctx.strokeStyle = "blue";
                    ctx.lineWidth = 10;
                    ctx.beginPath();
                    ctx.arc(mousePos.gameX, mousePos.gameY, 100, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(mousePos.gameX, mousePos.gameY);
                    var dX = mousePos.gameX - myCastle.x;
                    var dY = mousePos.gameY - myCastle.y;
                    var distance = Math.sqrt(dX * dX + dY * dY);
                    dX /= distance;
                    dY /= distance;
                    ctx.strokeStyle = "red";
                    ctx.lineTo(mousePos.gameX + -dX * 150, mousePos.gameY + -dY * 150);
                    ctx.stroke();
                    /*objects.forEach(obj => {
                        if (obj.value == "c"){
                            
                        }
                    });*/
                }
                else if (keysDown["m"]){
                    const minimapSize = 200;
                    const scaling = minimapSize/gameSize;
                    var rootX = mousePos.gameX - minimapSize;
                    var rootY = mousePos.gameY - minimapSize;
                    if (rootX < 0){
                        rootX = 0;
                    }
                    if (rootY < 0){
                        rootY = 0;
                    }
                    ctx.globalAlpha = 0.8;
                    ctx.fillStyle = "white";
                    ctx.fillRect(rootX, rootY, minimapSize, minimapSize);
                    ctx.fillStyle = "red";
                    ctx.fillRect(rootX + (mousePos.gameX) * scaling - 2.5, rootY + (mousePos.gameY) * scaling - 2.5, 5, 5);
                    Object.values(objects).forEach(obj => {
                        if (obj.value == "c"){
                            ctx.fillStyle = "green";
                            ctx.fillRect(rootX + obj.x * scaling - 2, rootY + obj.y * scaling - 2, 4, 4);
                        }
                        else if (obj.value != "b" && obj.value != "s" && obj.value != "w" && obj.value != "C"){
                            ctx.fillStyle = "black";
                            ctx.fillRect(rootX + obj.x * scaling - 1, rootY + obj.y * scaling - 1, 2, 2);
                        }
                    });
                    ctx.globalAlpha = 1;
                }
                ctx.translate(cX, cY);
                if (keysDown["ArrowUp"]){
                    yv -= 5;
                }
                if (keysDown["ArrowDown"]){
                    yv += 5;
                }
                if (keysDown["ArrowLeft"]){
                    xv -= 5;
                }
                if (keysDown["ArrowRight"]){
                    xv += 5;
                }
                yv *= 0.8;
                xv *= 0.8;
                cY += yv;
                cX += xv;
                if (cX < -window.innerWidth/2){
                    cX = -window.innerWidth/2;
                }
                if (cX > gameSize - window.innerWidth/2){
                    cX = gameSize - window.innerWidth/2;
                }
                if (cY < -window.innerHeight/2){
                    cY = -window.innerHeight/2;
                }
                if (cY > gameSize - window.innerHeight/2){
                    cY = gameSize - window.innerHeight/2;
                }
                if (playing){
                    styleInfotextMajor();
                    if (didSelectHome){
                        if (counter == 0){
                            if (timeToStart == -1){
                                ctx.fillText("Waiting for game start...", window.innerWidth/2, 100);
                            }
                            else {
                                ctx.fillText("Game will start in " + timeToStart, window.innerWidth / 2, 100);
                            }
                        }
                        else if (isStratChange){
                            timeToStart = -1;
                            if (inventoryPlace) {
                                if (canPlaceWall){
                                    ctx.fillText("Place your new gamepiece...", window.innerWidth / 2, 100);
                                }
                                else {
                                    ctx.fillText("Can't place a gamepiece here.", window.innerWidth / 2, 100);
                                }
                            }
                            else {
                                ctx.fillText("Move your ships!", window.innerWidth/2, 100);
                            }
                            // Ship movement goes here.
                        }
                    }
                    else{
                        if (canPlaceCastle){
                            ctx.fillText("Select Your Home Castle", window.innerWidth/2, 100);
                        }
                        else{
                            ctx.fillText("Can't place a castle here!", window.innerWidth / 2, 100);
                        }
                    }
                }
                else{
                    if (counter == 0) {
                        if (timeToStart == -1) {
                            ctx.fillText("You are a spectator. Waiting for game start...", window.innerWidth / 2, 100);
                        }
                        else {
                            ctx.fillText("You are a spectator. Game will start in " + timeToStart, window.innerWidth / 2, 100);
                        }
                    }
                    else{
                        ctx.fillText("You are a spectator!", window.innerWidth/2, 100);
                    }
                }
                ctx.font = "16px sans-serif";
                ctx.fillStyle = "white";
                ctx.textAlign = "left";
                ctx.fillText(score, 50, 50);
                ctx.fillStyle = "green";
                ctx.fillText("Time Left in " + (isStratChange ? "strategy mode" : "play mode") + ": " + counter, 50, 100);
                if (wallsRemaining > 0){
                    ctx.textAlign = "right";
                    if (!canPlaceWall){
                        //ctx.fillStyle = "red";
                    }
                    ctx.fillText("Remaining walls (" + (canPlaceWall ? "press W to place one!" : "can't place here!") + "): " + wallsRemaining, window.innerWidth - 50, 50);
                }
                if (effect == "CRT"){
                    ctx.beginPath();
                    ctx.strokeStyle = "darkgrey";
                    ctx.lineWidth = 0.5;
                    const lineCount = 100;
                    for (var y = 0; y < lineCount; y ++){
                        var linePos = y * window.innerHeight/lineCount;
                        linePos += CRTEffectWipe % (window.innerHeight/lineCount);
                        CRTEffectWipe += 0.01;
                        ctx.moveTo(0, linePos);
                        ctx.lineTo(window.innerWidth, linePos);
                    }
                    ctx.stroke();
                }
            }

            function play() {
                document.getElementById("mainscreen").style.display = "none";
                document.getElementById("game").style.display = "";

                window.addEventListener("mouseup", (evt) => {
                    if (didSelectHome){
                        if (inventoryPlace){
                            if (canPlaceWall){
                                connection.send("p" + inventoryPlace + " " + mousePos.gameX + " " + mousePos.gameY);
                                inventoryPlace = undefined;
                            }
                        }
                        else if (inventoryHovered != -1) {
                            if (inventoryStuff[inventoryHovered].word){
                                if (inventoryStuff[inventoryHovered].place) {
                                    inventoryPlace = inventoryStuff[inventoryHovered].word;
                                }
                                else{
                                    connection.send("p" + inventoryStuff[inventoryHovered].word + " " + (myCastle.x + (Math.random() * 300 - 150)) + " " + (myCastle.y + (Math.random() * 300 - 150)));
                                }
                            }
                            else {
                                inventoryStuff[inventoryHovered].cbk();
                            }
                            inventoryMode = false;
                        }
                        else if (isStratChange){
                            if (angleAdjustMode) {
                                angleAdjustMode = false;
                                selected = undefined;
                                hovered = undefined;
                            }
                            else {
                                if (selected){
                                    angleAdjustMode = true;
                                }
                                if (hovered) {
                                    hovered.selected = true;
                                    selected = hovered;
                                }
                            }
                        }
                    }
                    else {
                        if (canPlaceCastle){
                            connection.send("pc " + mousePos.gameX + " " + mousePos.gameY); // place castle at position
                            didSelectHome = true;
                        }
                    }
                });
                
                mainloop();
            }

            window.onresize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            
            window.onresize();
        </script>
    </body>
</html>